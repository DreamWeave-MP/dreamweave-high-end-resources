#!/usr/bin/env bash

set -e

echo "Retrieving Wareya shaders . . ."

url="https://github.com/wareya/OpenMW-Shaders/archive/refs/heads/main.zip"

wget -q --show-progress -O "wareya-shaders.zip" "${url}"
unzip wareya-shaders.zip && rm wareya-shaders.zip
cd OpenMW-Shaders-main

mv LICENSE wareya-shad-LICENSE
mv README.md wareya-shad-README.md

mv EXPERIMENTS/* shaders
rm -r EXPERIMENTS

cp -r wareya-shad-LICENSE wareya-shad-README.md shaders ../dev-res/resources/vfs
cp -r wareya-shad-LICENSE wareya-shad-README.md shaders ../stable-res/resources/vfs

cd -
rm -r OpenMW-Shaders-main

cp -r dev-res dev-res-vanillaWater
cp -r stable-res stable-res-vanillaWater

# For variants which do not have the appropriate edits to use the water shader, remove them for deployment
cd stable-res-vanillaWater/resources/vfs/shaders/
rm water.omwfx waterLite.omwfx waterLite2.omwfx waterNew.omwfx waterUltraLite.omwfx
cd - && cd dev-res-vanillaWater/resources/vfs/shaders
rm water.omwfx waterLite.omwfx waterLite2.omwfx waterNew.omwfx waterUltraLite.omwfx
cd -

awk '/gl_FragData\[0\] = applyFogAtDist\(/ {
    print $0
    print "    gl_FragData[0] = vec4(0.0);"
    next
} 1' stable-res/resources/shaders/compatibility/water.frag > tmpfile && mv tmpfile stable-res/resources/shaders/compatibility/water.frag

awk '/gl_FragData\[0\] = applyFogAtDist\(/ {
    print $0
    print "    gl_FragData[0] = vec4(0.0);"
    next
} 1' dev-res/resources/shaders/compatibility/water.frag > tmpfile && mv tmpfile dev-res/resources/shaders/compatibility/water.frag

touch stable-res/settings.cfg
cat << 'EOF' >> stable-res/settings.cfg
# https://github.com/wareya/OpenMW-Shaders/tree/main?tab=readme-ov-file#using-the-water-shader
[Water]
reflection detail = 0
refraction = false
rtt size = 512
shader = true
rain ripple detail = 1

EOF
cp stable-res/settings.cfg dev-res/settings.cfg

mv stable-res stable-res-wareyaWater
mv dev-res dev-res-wareyaWater

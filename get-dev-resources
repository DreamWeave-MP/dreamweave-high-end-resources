#!/usr/bin/env bash

set -e 

rm -rf dev-res

base_url="https://gitlab.com/OpenMW/openmw/-/jobs/artifacts/master/raw/OpenMW_MSVC2022_64_RelWithDebInfo_master.zip?job=Windows_Merge_Artifacts_MSBuild_RelWithDebInfo"

wget -q --show-progress -O openmw-dev.zip "${base_url}"

echo Extracting development resources folder to $(pwd)/dev-res
unzip openmw-dev.zip 'resources/*' && rm -f openmw-dev.zip

version_content=$(cat resources/version | tr -d \\r | tr \\n ':')
version_number=$(echo $version_content | cut -f 1 -d ':')
version_commit=$(echo $version_content | cut -f 2 -d ':')

echo Downloaded development OpenMW archive for development build of version: ${version_number}, commit: ${version_commit}, cleaning up archive

if [[ $GITHUB_ACTIONS ]]; then
  echo "OPENMW_DEV_VERSION=${version_number}" >> $GITHUB_OUTPUT
  echo "OPENMW_DEV_COMMIT=${version_commit}" >> $GITHUB_OUTPUT
fi

mkdir dev-res
cp -rf resources/vfs-mw/* resources/vfs
rm -rf resources/vfs-mw
mv resources dev-res
